
\begin{tabular}{lll}
  \centering
  Author &  O. Bonnefon &2010\\
  Revision& section 9.1 to 9.3 V. Acary&  05/09/2011
\end{tabular}
\section{The Equations of motion}

The equations of motion in the Newton-Euler(\cite{Wittenburg1977,Haug89} formalism can be stated as
\begin{equation}
  \label{eq:NewtonEuler}
  \left\{\begin{array}{rcl}
    M \dot V &=& F_{ext}(X, V, \Omega, R), \\
    I \dot \Omega + \Omega \times I\Omega &=&  M_{ext}(X,V, \Omega, R), \\
    \dot X &=& V, \\
    \dot R &=& R \tilde \Omega,\quad R^{-1}=R^T,\quad  \det(R)=1 .
\end{array}\right.
\end{equation}
with
\begin{itemize}
\item $x_G,v_G$ position and velocity of the center of mass expressed in a spatial frame
\item $\Omega$ angular velocity vector expressed in the inertial frame (frame attached to the object)
\item $R$ rotation matrix form the spatial frame to the inertia frame \footnote{$R^{-1}=R^T, \det(R)=1$, \textit{i.e} $ R\in SO^+(3)$} $R$ 
\item $M=m\,I_{3\times 3}$ diagonal mass matrix
\item $m \in \RR$ mass
\item $I$ constant inertia matrix
\item $F_{ext}$ and $ M_{ext}$ are the external applied forces and torques
\end{itemize}


\section{The relation}

Let us define by $q$ by  the position and the orientation, we don't focus on the  representation of the orientation.
\begin{equation}
\label{Relation}
\begin{array}{l}
Y=H(q)  \\
R=G(q,\lambda)
\end{array}
\end{equation}


The first equation is derived:
\[\dot Y = C \dot q + \dot H\]
Let us assume that it exists an operator $T$ such that :
\[T:  \left(\begin{array}{l} V\\ \Omega\end{array}\right) \to \dot q \]
Using  this operator, (\ref{Relation}) leads to :
\[\dot Y = C T \left(\begin{array}{l} V\\ \Omega\end{array}\right) + \dot H\]

\section{Time discretization $t_k \to t_{k+1}$, and implementation in Siconos}
The goal of this section is to describe the computation done in Siconos. The unknown are denoted according to the Siconos convention.
\subsection{The unknowns}

The unknowns stored in the \texttt{NewtonEulerDS} class are the velocity
\[\_v_{k}=\left(\begin{array}{c} V_k\\ \Omega _{k}\end{array}\right)\]
and  the parameter $\_q_{k}$ that locates the system. Usually it may be the coordinate of the center of mass and a representation of the orientation (quaternion, Euler Angles, ...).

\subsection{Explicit case}
It consists in evaluating $\Omega  \wedge I\Omega $ in an explicit way. We note that it can cause trouble (numerical instabilities) for object having an important condition number of the inertial matrix.
The dynamical system~(\ref{NE_Dyn1}) results in to the system:
\begin{equation}
  \left(\begin{array}{cc} m&0\\0&I\end{array}\right)
   (\_v_{k+1}-\_v_{k})=
   h\, \big[\_Fl_k +
    (CT)^\top \lambda _{k+1}\big]
  \end{equation}
  with the total forces applied to the system \[\_Fl_k = \left(\begin{array}{c} Fext_k\\ Mext_k - \Omega _k \wedge I\Omega _k \end{array}\right)\]
We note $W = \left(\begin{array}{cc} m&0\\0&I\end{array}\right) ^{-1} $

\subsection{$\theta$ method case}
It consists in evaluating $\Omega  \wedge I\Omega $ as $\Omega _{k+\theta}  \wedge I\Omega _{k+\theta} $.
\begin{equation}
  \left(\begin{array}{cc} m&0\\0&I\end{array}\right)
   (\_v_{k+1}-\_v_{k})=
   h (1-\theta)\_Fl_k + h \theta Fl_{k+1} +
   (CT)^\top h\lambda _{k+1}
  \label{eq:NE-thetaScheme} 
 \end{equation}

Using the linearization $$Fl_{k+1} = \_Fl_{k}+\nabla _v Fl (\_v_{k+1}-\_v_{k})$$system~(\ref{eq:NE-thetaScheme}) leads to:
\begin{equation}
  \left(\left(\begin{array}{cc} m&0\\0&I\end{array}\right)-h\theta\nabla _v Fl\right)
   (\_v_{k+1}-\_v_{k})=
   h \_Fl_k + (CT)^\top h\lambda _{k+1}
  \end{equation}
and we set $W =  \left(\left(\begin{array}{cc} m&0\\0&I\end{array}\right)-h\theta\nabla _v Fl\right)^{-1} $


\begin{ndrva}
  From this point, I do not understand

  Normally, $F_{ext}$ et $M_{ext}$ depends on $V,X,\Omega, R$. Where are the Jacobian ?  Where  is the substitution of the nonlinear equation in $q$ ?
\end{ndrva}


\[ (\Omega+\epsilon)  \wedge I(\Omega+\epsilon)=  \Omega  \wedge I\Omega + \epsilon \wedge I \Omega +  \Omega  \wedge I \epsilon + O(\epsilon ^2)\]
case $\epsilon = h*e_i$ leads to:
\begin{equation}
  \label{eq:NE_nablaFL1}
  \frac{\partial (\Omega \wedge I\Omega)}{\partial e_i}=e_i\wedge I\Omega+\Omega \wedge Ie_i
  \end{equation}
\[\nabla _v Fl = \left(\begin{array}{cc}
0_{3x3}&0_{3x3}\\
0_{3x3}&\left(\frac{\partial (\Omega \wedge I\Omega)}{\partial e_i}\right)_{i=1,2,3}
\end{array}\right)\]

\subsection{Building of the OSNSP}

\begin{equation}
  \label{NE_dis_explicit}
  \fbox{$
   \_v_{k+1}=
   W (h \_Fl_k)+
   W (CT)^\top h\lambda _{k+1}+ \_v_k
   $}
  \end{equation}
  This computation is done in Moreau::updateState, using:
  \[\_ResiduFree_k = -h \_Fl_k\]
  \[Xfree_k = -W \_ResiduFree_k + \_v_k\]

The relation~\ref{Relation} leads to the system:

\[\dot Y _{k+1}= C T \_v_{k+1} + \dot H _{k} \]
Substitute $  \_v_{k+1} $ using~\ref{NE_dis_explicit} leads:

\[\dot Y _{k+1}= C T \lbrack W h\_Fl_k+
   hW(CT)^\top \lambda _{k+1}+ \_v_k \rbrack
   + \dot H _{k} = C T \lbrack  hW (CT)^\top \lambda _{k+1}+ Xfree_k \rbrack
   + \dot H _{k}\]
Ones gets:
\[\fbox{$
\dot Y _{k+1}= C T W (CT)^\top (h\lambda _{k+1}) + CT Xfree_k +\dot H _{k} $}\]


Solving the one step problem gives $h\lambda _{k+1}$, and from~\ref{NE_dis_explicit} we get
$ \_v_{k+1} $. At least, $ \_v_{k+1} $ is used to compute $\dot \_q_{k+1}$, provided $\_q_{k+1}$.

\section{Quaternion case}
Working in 3D, we chose $\_q= \left(\begin{array}{l} X_g \\q \end{array}\right) $. $X_g$ are the 3 coordinates of the center of mass, and $q$ is a quaternion
  represented the orientation of solid. It means :
  \[q_k(0,GM_0)q_k^c = (0,GM_k)\]
Where G is the center of mass, and M any point of the solid.\\
This section describes the $T$ operator in this case. Computation using quaternion leads to the relation:
\[\dot q = \frac{1}{2} q (0,\Omega)\]
So using the matrix formulation:
\[\dot q = \frac{1}{2}  \left(\begin{array}{cccc} q_0&-q_1&-q_2&-q_3 \\ q_1&q_0&-q_3&q_2\\
  q_2&q_3&q_0&-q_1\\ q_3&-q_2&-q_1&q_0\end{array}\right)  \left(\begin{array}{c} 0 \\ \Omega
  \end{array}\right) =
  T_q   \Omega  \]
  That lead to :
  \[ \dot \_q = \left(\begin{array}{cc} I_3 & 0 \\ 0 &
  T_q \end{array}\right) \left(\begin{array}{c} V\\ \Omega  \end{array}\right)  = T
  \left(\begin{array}{c} V\\ \Omega  \end{array}\right)=T \_v\]

It is noteworthy that $T$ must be updated at each step.

\section{The Newton linearization applied to NewtonEuler formalisme}
  Let us define the residu:
\begin{equation}
  \label{eq:newton_NE1_residu}
  \mathcal R_k (v,\lambda) =W(v-v_k)-hF_{ext}-(CT)^\top\lambda
\end{equation}
The linearized residu is:
\begin{equation}
  \label{eq:newton_NE1_residuL}
  \mathcal R_{L_k} (v,\lambda) =\mathcal R_k (v_k,\lambda_k)+W(v-v_k)-(CT)^\top(\lambda - \lambda_k)
\end{equation}

Let us define $v_k^p$ and $\lambda_k^p$ the current Newton iteration, initialized with $v_k$ and $\lambda_k$.
We are looking for $v_k^{p+1}$ and $\lambda_k^{p+1}$ such that $R_{L_k} (v_k^{p+1},\lambda_k^{p+1}) =0$. That is:
\begin{equation}
  \label{eq:newton_NE1_eq1}
  0 =\mathcal R_k (v_k^p,\lambda_k^p)+W(v_k^{p+1}-v_k^p)-(CT)^\top(\lambda_k^{p+1} - \lambda_k^p)
\end{equation}
That leads to:
\begin{equation}
  \label{eq:newton_NE1_eq2}
  v_k^{p+1} =v_k^p+W^{-1}[-\mathcal R_k (v_k^p,\lambda_k^p)+(CT)^\top(\lambda_k^{p+1} - \lambda_k^p)]
\end{equation}
The NSLAW is:
\begin{equation}
  \label{eq:newton_NE1_nslaw1}
  \dot y_k^{p+1}=CTv_k^{p+1}
\end{equation}
that leads to the OSNSP:
\begin{equation}
  \label{eq:newton_NE1_osnsp}
  \dot y_k^{p+1}=(CT)W^{-1}~(CT)^\top\lambda_k^{p+1}+(CT)[v_k^p-(CT)(CT)^\top\lambda_k^p-W^{-1}\mathcal R_k (v_k^p,\lambda_k^p)]
\end{equation}
\subsection{Siconos implementation}

The expression:~$W(v_k^p-v_k)-hF_{ext}$ is saved in DS->residiFree.Moreau->computeResidu.\\
The expression:~$\mathcal R_k(v_k^p,\lambda_k^p)=W(v_k^p-v_k)--hF_{ext}+(CT)^\top(\lambda_k^p)$ is saved in DS->workFree.\\
The expression:~$vfree=\dot y_k^{p} - W^{-1} residufree$ is saved in DS->workFree. Moreau->computeFreeState.\\
The computation:~ $y_k^{p+1}=vfree+W^{-1}\lambda_k^{p+1}$ is done in OSI::updateState.\\
The OSNSP is :
\begin{equation}
  \dot y_k^{p+1}=(CT)W^{-1}~(CT)^\top\lambda_k^{p+1}+(CT)vfree+nslaweffect
\end{equation}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "DevNotes"
%%% End: 
