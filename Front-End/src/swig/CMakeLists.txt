OPTION(WITH_SERIALIZATION "Generates bindings with IO serialization for picklable objects" OFF)
OPTION(WITH_OCC "Generation of bindings for Mechanics/OpenCascade interface" OFF)
OPTION(WITH_FCLIB "Generation of bindings for fclib interface" OFF)

IF(WITH_SERIALIZATION)
  SET(CMAKE_SWIG_FLAGS "${CMAKE_SWIG_FLAGS};-DWITH_SERIALIZATION")
ENDIF()

# cf http://stackoverflow.com/questions/435708/any-way-in-cmake-to-require-gcc-version-4
# with cmake version >= 2.8.8 we can use CMAKE_C_COMPILER_VERSION and
# CMAKE_CXX_COMPILER_VERSION
IF(CMAKE_COMPILER_IS_GNUCXX)
  EXEC_PROGRAM(
    ${CMAKE_CXX_COMPILER}
    ARGS                    --version
    OUTPUT_VARIABLE _compiler_output)
  STRING(REGEX REPLACE ".*([0-9]\\.[0-9]\\.[0-9]).*" "\\1"
    gcc_compiler_version ${_compiler_output})
  MESSAGE(STATUS "C++ compiler version: ${gcc_compiler_version} [${CMAKE_CXX_COMPILER}]")
  
  IF(gcc_compiler_version VERSION_LESS "4.4")
    MESSAGE(FATAL_ERROR "gcc greater than 4.4 needed")
  ENDIF()
ENDIF()

find_package(PythonFull REQUIRED)
include(FindPythonModule)

INCLUDE_DIRECTORIES(${PYTHON_INCLUDE_DIR})

INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR})

COMPILE_WITH(Python_Numpy REQUIRED)

FIND_PACKAGE(SWIG 2.0.7 REQUIRED)
INCLUDE(${SWIG_USE_FILE})


# Numerics + Kernel 
COMPILE_WITH(SiconosNumerics REQUIRED)
COMPILE_WITH(SiconosKernel REQUIRED)


COMPILE_WITH(SiconosMechanics)
IF(SiconosMechanics_FOUND)
  SET(HAVE_SICONOS_MECHANICS 1)
ENDIF()

COMPILE_WITH(SiconosControl)
IF(SiconosControl_FOUND)
  SET(HAVE_SICONOS_CONTROL 1)
ENDIF()

COMPILE_WITH(SiconosIO)

FIND_PACKAGE(Boost REQUIRED)

IF(SiconosIO_FOUND)
  SET(HAVE_SICONOS_IO TRUE)
  FIND_PACKAGE(Boost COMPONENTS serialization REQUIRED)
ENDIF(SiconosIO_FOUND)

COMPILE_WITH(Boost REQUIRED)

COMPILE_WITH(GMP REQUIRED)

COMPILE_WITH(BLAS REQUIRED)
COMPILE_WITH(LAPACK REQUIRED)

# contact detection
IF(WITH_BULLET)
  COMPILE_WITH(Bullet REQUIRED)
  IF(BULLET_FOUND)
    SET(HAVE_BULLET 1)
    MESSAGE( STATUS "Bullet include dirs : ${BULLET_INCLUDE_DIRS}" )
    IF(BULLET_USE_DOUBLE_PRECISION)
      APPEND_CXX_FLAGS("-DBT_USE_DOUBLE_PRECISION")
    ENDIF(BULLET_USE_DOUBLE_PRECISION)
  ENDIF(BULLET_FOUND)
ENDIF(WITH_BULLET)


IF(WITH_FCLIB)
  COMPILE_WITH(FCLIB REQUIRED)
ENDIF(WITH_FCLIB)

IF(WITH_OCC)
  COMPILE_WITH(OCE REQUIRED)
  LIST(REMOVE_ITEM ${PROJECT_NAME}_LINK_LIBRARIES DRAWEXE)
  COMPILE_WITH(FreeCAD COMPONENTS Part REQUIRED)
ENDIF()

IF(SYSTEM_ARCHITECTURE)
  SET(CMAKE_SWIG_FLAGS "${CMAKE_SWIG_FLAGS};-D__${SYSTEM_ARCHITECTURE}__")
ENDIF()

IF(CROSSCOMPILING_LINUX_TO_WINDOWS)
  SET(EMULATOR "wine")
  SET(DRIVE_LETTER "Z:")
ELSE()
  SET(EMULATOR)
  SET(DRIVE_LETTER)
ENDIF()

IF(CMAKE_SYSTEM_NAME MATCHES Windows)
  SET(VAR_SEPARATOR ";")
ELSE()
  SET(VAR_SEPARATOR ":")
ENDIF()

#set correct lib install path on linux
IF(CMAKE_SYSTEM_NAME MATCHES Linux)
  IF(CMAKE_SIZEOF_VOID_P EQUAL 4)
    SET(LIB_SUFFIX "")
  ELSE(CMAKE_SIZEOF_VOID_P EQUAL 4)
    SET(LIB_SUFFIX "64")
  ENDIF()
ELSEIF(CMAKE_SYSTEM_NAME MATCHES Windows)
  APPEND_CXX_FLAGS("/bigobj")
ENDIF()

# For some environment variables (LD_LIBRARY_PATH, DYLD_LIBRARY_PATH, Path)
SET(SICONOS_NUMERICS_PATH "${CMAKE_INSTALL_PREFIX}/lib${LIB_SUFFIX}")

IF(CMAKE_SYSTEM_NAME MATCHES "Windows")
  STRING(REGEX REPLACE "\\\;" ";" ENV_PATH "$ENV{PATH}")
  STRING(REGEX REPLACE "/" "\\\\" SICONOS_NUMERICS_PATH "${SICONOS_NUMERICS_PATH}")
  # remove trailing backslash and quote for python
  STRING(REGEX REPLACE "\"" "" ENV_PATH_FOR_RUNTEST "${ENV_PATH}")
  STRING(REGEX REPLACE "\\\\$" "" ENV_PATH_FOR_RUNTEST "${ENV_PATH_FOR_RUNTEST}")
ENDIF()

CONFIGURE_FILE(setup.py.in setup.py)

CONFIGURE_FILE(runtest.py.in ${CMAKE_BINARY_DIR}/src/swig/runtest.py)

find_python_module(pytest REQUIRED)

SUBDIRS(Siconos)

ADD_CUSTOM_TARGET(distutils-install
  COMMAND ${PYTHON_EXECUTABLE} ${CMAKE_CURRENT_BINARY_DIR}/setup.py build
  COMMAND ${PYTHON_EXECUTABLE} ${CMAKE_CURRENT_BINARY_DIR}/setup.py install
  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
  COMMENT "Installing with distutils")

#

IF(EXISTS ${CMAKE_SOURCE_DIR}/config.h.cmake)
  CONFIGURE_FILE(${CMAKE_SOURCE_DIR}/config.h.cmake ${PROJECT_SHORT_NAME}Config.h)
ENDIF(EXISTS ${CMAKE_SOURCE_DIR}/config.h.cmake)


# config.h
INSTALL(FILES ${CMAKE_BINARY_DIR}/FrontEndConfig.h DESTINATION include/Siconos/FrontEnd)

# print all features
FEATURE_SUMMARY(WHAT ALL)

# To have a full print of variables, use -DPRINT_ENV=ON
message(STATUS "\n============================================ Summary ============================================")
message(STATUS "${PROJECT_NAME} version ${VERSION} is now ready for compilation and installation.")
message(STATUS "To proceed run 'make' and 'make install' and optionaly 'make test'.")
message(STATUS " C++ Compiler : ${CMAKE_CXX_COMPILER}")
message(STATUS " C Compiler : ${CMAKE_C_COMPILER}")
message(STATUS " Compilation mode is : ${CMAKE_BUILD_TYPE}")
message(STATUS " Code Sources are in : ${CMAKE_SOURCE_DIR}")
message(STATUS " The project will be installed in ${CMAKE_INSTALL_PREFIX}")
message(STATUS " The Numerics library used is : ${SiconosNumerics_FOUND}")
message(STATUS " The Kernel library used is : ${SiconosKernel_FOUND}")
message(STATUS " The Python libraries are : ${PYTHON_LIBRARIES}")
message(STATUS " The Python includes are : ${PYTHON_INCLUDE_DIR}")
message(STATUS " To get more information about dependencies, config or else, ")
message(STATUS "check CMakeCache.txt file or re-run cmake with -DPRINT_ENV=ON.")
message(STATUS "=================================================================================================\n")
