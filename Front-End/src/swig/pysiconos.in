#!/usr/bin/env python

import os
import sys
import fnmatch
from subprocess import call

compiler = {
    'c': '${CMAKE_C_COMPILER}',
    'cpp': '${CMAKE_CXX_COMPILER}'
}



if __name__ == '__main__':

    pythonFile = sys.argv[1]
    baseDir = os.path.abspath(os.path.dirname(pythonFile))
    if len(sys.argv) >= 3:
        outputDir = sys.argv[2]
    else:
        outputDir = baseDir
    if not os.path.isdir(outputDir):
        os.makedirs(outputDir)
    pluginDir = baseDir + '/plugins/'
    if os.path.isdir(pluginDir):
        for ext in compiler.keys():
            for plugin in fnmatch.filter(os.listdir(pluginDir), '*.' + ext):
                # compile C plugin
                pluginBase = os.path.basename(plugin)
                pluginSO = outputDir + os.path.splitext(pluginBase)[0] + '.so'
                pluginFile = pluginDir + plugin
                call(compiler[ext] + ' -I{2} -O3 -lm -fPIC -shared -o {0} {1}'.format(pluginSO, pluginFile, pluginDir), shell=True)
