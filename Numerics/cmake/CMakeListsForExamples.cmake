SET(EXAMPLE @EXAMPLE@)

SET(CROSSCOMPILING_LINUX_TO_WINDOWS @CROSSCOMPILING_LINUX_TO_WINDOWS@)

ENABLE_TESTING()

MACRO(ADD_EXAMPLE _N _EX)
  MESSAGE("Adding example ${_N} (${_EX})")


  IF(CROSSCOMPILING_LINUX_TO_WINDOWS)
    ADD_TEST(${_N} wine ${_EX}.exe)
  ELSE()
    ADD_TEST(${_N} "${_EX}")
  ENDIF()

  IF (APPLE)
    SET_TESTS_PROPERTIES(${_N} PROPERTIES ENVIRONMENT DYLD_LIBRARY_PATH=$ENV{DYLD_LIBRARY_PATH}:@SiconosKernel_LIBRARY_DIRS@:.)
  ELSEIF(CMAKE_SYSTEM_NAME MATCHES Windows)
    SET_TESTS_PROPERTIES(${_N} PROPERTIES ENVIRONMENT "Path=@SiconosKernel_LIBRARY_DIRS@\;@ENV_PATH@")
  ELSE() # unix
    SET_TESTS_PROPERTIES(${_N} PROPERTIES ENVIRONMENT LD_LIBRARY_PATH=$ENV{LD_LIBRARY_PATH}:@SiconosKernel_LIBRARY_DIRS@:.)
  ENDIF()

  SET_TESTS_PROPERTIES(${_N} PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR")
ENDMACRO(ADD_EXAMPLE _N _EX)

IF(NOT EXAMPLE MATCHES Plugin)
  SET(TEST_ME TRUE)
  FOREACH(_NT ${NO_TEST_FILES})
    IF(EXAMPLE MATCHES "${_NT}")
      SET(TEST_ME FALSE)
    ENDIF(EXAMPLE MATCHES "${_NT}")
  ENDFOREACH(_NT ${NO_TEST_FILES})
  IF(TEST_ME)
    GET_FILENAME_COMPONENT(EXAMPLE_PATH ${EXAMPLE} PATH)
    GET_FILENAME_COMPONENT(EXAMPLE_NAME ${EXAMPLE} NAME_WE)
    FILE(GLOB EXAMPLES_XML ${EXAMPLE_PATH}/*.xml)
    FOREACH(_F ${EXAMPLES_XML})
      GET_FILENAME_COMPONENT(EXAMPLE_XML ${_F} NAME)
      MESSAGE(STATUS "Found xml file : ${_F}")
      MESSAGE(STATUS "Configuring file : ${CMAKE_CURRENT_BINARY_DIR}/${EXAMPLE_XML}")
      CONFIGURE_FILE(${_F} ${CMAKE_CURRENT_BINARY_DIR}/${EXAMPLE_XML}  @COPYONLY)
    ENDFOREACH(_F ${EXAMPLES_XML})
    FILE(GLOB EXAMPLES_REF ${EXAMPLE_PATH}/*.ref)
    FOREACH(_F ${EXAMPLES_REF})
      GET_FILENAME_COMPONENT(EXAMPLE_REF ${_F} NAME)
      MESSAGE(STATUS "Found ref file : ${_F}")
      MESSAGE(STATUS "Configuring file : ${CMAKE_CURRENT_BINARY_DIR}/${EXAMPLE_REF}")
      CONFIGURE_FILE(${_F} ${CMAKE_CURRENT_BINARY_DIR}/${EXAMPLE_REF}  @COPYONLY)
    ENDFOREACH(_F ${EXAMPLES_REF})
    ADD_CUSTOM_COMMAND(OUTPUT ${EXAMPLE_NAME}
      COMMAND "${SiconosKernel_EXE_DIR}/siconos" --generator="${CMAKE_GENERATOR}" --noexec "${EXAMPLE}" --build-dir build -DCMAKE_TOOLCHAIN_FILE="${CMAKE_TOOLCHAIN_FILE}")
    GET_FILENAME_COMPONENT(EXAMPLE_DIR ${EXAMPLE} PATH)
    GET_FILENAME_COMPONENT(EXAMPLE_UPDIR ${EXAMPLE_DIR} NAME)
    SET(EX_TARGET "${EXAMPLE_UPDIR}-${EXAMPLE_NAME}-target")
    ADD_CUSTOM_TARGET(${EX_TARGET} ALL DEPENDS ${EXAMPLE_NAME})
    ADD_EXAMPLE(${EXAMPLE_NAME} ${EXAMPLE_NAME})
  ENDIF(TEST_ME)
ENDIF(NOT EXAMPLE MATCHES Plugin)

